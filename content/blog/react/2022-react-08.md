---
title: '[ë²ˆì—­] #8: ì´í™í‹°ë¸Œ ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ í‚¤'
date: 2022-05-19 20:13:16
category: react
thumbnail: './images/react.png'
draft: false
---


<div>

<img src="./images/2022-react-00.png">

</div>

> Thanks for [@TkDodo](https://github.com/tkdodo)
>> í•´ë‹¹ ì»¨í…ì¸ ëŠ” [ì›ê¸€](https://tkdodo.eu/blog/effective-react-query-keys)ì„ ë²ˆì—­í•œ ê²ƒì…ë‹ˆë‹¤. ì˜¤íƒ€, ì˜¤ì—­ ì§€ì ì€ í™˜ì˜ì´ì—ìš”!

<br>

# #8: Effective React Query Keys

[ì¿¼ë¦¬ í‚¤](https://react-query.tanstack.com/guides/query-keys)ëŠ” React Queryì—ì„œ ë§¤ìš° ì¤‘ìš”í•œ ê°œë…ì…ë‹ˆë‹¤. ì¿¼ë¦¬ì— ëŒ€í•œ ì¢…ì†ì„±ì´ ë³€ê²½ë˜ë©´ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì˜¬ë°”ë¥´ê²Œ ìºì‹œí•˜ê³  ìë™ìœ¼ë¡œ ë‹¤ì‹œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•´ í•„ìš”í•˜ì£ . ë§ˆì§€ë§‰ìœ¼ë¡œ, ì¿¼ë¦¬ ìºì‹œì™€ ìˆ˜ë™ìœ¼ë¡œ ìƒí˜¸ ì‘ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ mutation í›„ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ì¼ë¶€ ì¿¼ë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë¬´íš¨í™”(invalidate)í•´ì•¼ í•˜ëŠ” ê²½ìš°ì²˜ëŸ¼ í•„ìš”í•  ë•Œì²˜ëŸ¼ìš”.

ì´ëŸ¬í•œ ì‘ì—…ì„ ë³´ë‹¤ íš¨ê³¼ì ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ ì¿¼ë¦¬ í‚¤ë¥¼ êµ¬ì„±í–ˆë˜ ê°œì¸ì ì¸ ë°©ë²•ì„ ì„¤ëª…í•˜ê¸° ì „ì— ì´ ì„¸ ê°€ì§€ê°€ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ì§€ ê°„ë‹¨íˆ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

## **Caching Data**

ë‚´ë¶€ì ìœ¼ë¡œ ì¿¼ë¦¬ ìºì‹œëŠ” ë‹¨ì§€ JavaScript ê°œì²´ì´ì, í‚¤ëŠ” ì§ë ¬í™”ëœ ì¿¼ë¦¬ í‚¤, ê°’ì€ ì¿¼ë¦¬ ë°ì´í„°ì™€ ë©”íƒ€ ì •ë³´ì…ë‹ˆë‹¤. í‚¤ëŠ” [ê²°ì •ë¡ ì  ë°©ì‹](https://react-query.tanstack.com/guides/query-keys#query-keys-are-hashed-deterministically)ìœ¼ë¡œ í•´ì‹œë˜ë¯€ë¡œ ê°ì²´ë“¤ë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ë‹¨, ìµœìƒìœ„ ìˆ˜ì¤€ì—ì„œëŠ” í‚¤ê°€ ë¬¸ìì—´ ë˜ëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤).

ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì€ ì¿¼ë¦¬ í‚¤ê°€ ê³ ìœ í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. React Queryê°€ ìºì‹œì—ì„œ í‚¤ì— ëŒ€í•œ í•­ëª©ì„ ì°¾ìœ¼ë©´ ê·¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. *useQuery*ì™€ *useInfiniteQuery*ì—ëŠ” ë™ì¼í•œ í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ìš”. ê²°êµ­ ì¿¼ë¦¬ ìºì‹œëŠ” í•˜ë‚˜ë¿ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì´ ë‘˜ ì‚¬ì´ì— ë°ì´í„°ë¥¼ ê³µìœ í•˜ê²Œ ë¼ì£ . ë¬´í•œ ì¿¼ë¦¬(infinite queries)ëŠ” "ì¼ë°˜" ì¿¼ë¦¬ì™€ ê·¼ë³¸ì ìœ¼ë¡œ ë‹¤ë¥¸ êµ¬ì¡°ë¥¼ ê°€ì§€ê¸° ë•Œë¬¸ì— ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤.

```tsx
useQuery(['todos'], fetchTodos)

// ğŸš¨ this won't work
useInfiniteQuery(['todos'], fetchInfiniteTodos)

// âœ… choose something else instead
useInfiniteQuery(['infiniteTodos'], fetchInfiniteTodos)
```

## **Automatic Refetching**

> **ì¿¼ë¦¬ëŠ” ì„ ì–¸í˜•ì…ë‹ˆë‹¤.**
> 

ì´ê²ƒì€ ì•„ë¬´ë¦¬ ê°•ì¡°í•´ë„ ì§€ë‚˜ì¹˜ì§€ ì•ŠëŠ” ë§¤ìš° ì¤‘ìš”í•œ ê°œë…ì´ì—ìš”. ëŒ€ë¶€ë¶„ì˜ ì‚¬ëŒë“¤ì€ ì¿¼ë¦¬, íŠ¹íˆ refetchingì„ ëª…ë ¹í˜•ìœ¼ë¡œ ìƒê°í•˜ëŠ”ë°, "í´ë¦­"í•˜ëŠ” ë°ë„ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì–´ë–¤ ë°ì´í„°ë¥¼ fetchí•˜ëŠ” ì¿¼ë¦¬ê°€ í•˜ë‚˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ë²„íŠ¼ì„ í´ë¦­í•˜ê³  refetchê°€ ë˜ê¸¸ ê¸°ëŒ€í•˜ì§€ë§Œ ë‹¤ë¥¸ ë§¤ê°œ ë³€ìˆ˜ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì €ëŠ” ì´ëŸ° ì‹œë„ë¥¼ ë§ì´ ë´ì™”ì–´ìš”.

```tsx
function Component() {
  const { data, refetch } = useQuery(['todos'], fetchTodos)

  // â“ how do I pass parameters to refetch â“
  return <Filters onApply={() => refetch(???)} />
}
```

ì •ë‹µì´ ì—¬ê¸° ìˆìŠµë‹ˆë‹¤. **ì´ë ‡ê²Œ í•˜ì§€ ì•Šì•„ë„ ë¼ìš”.**

refetchì˜ ëœ»ì€ ê·¸ê²Œ ì•„ë‹ˆë¼, ë™ì¼í•œ ë§¤ê°œ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ refetchingì„ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ë°ì´í„°ë¥¼ ë³€ê²½í•˜ëŠ” ìƒíƒœê°€ ìˆëŠ” ê²½ìš° í‚¤ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ refetchê°€ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë˜ë¯€ë¡œ ì¿¼ë¦¬ í‚¤ì— ë°ì´í„°ë¥¼ ë„£ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. ë”°ë¼ì„œ í•„í„°ë¥¼ ì ìš©í•˜ë ¤ëŠ” ê²½ìš° í´ë¼ì´ì–¸íŠ¸ ìƒíƒœë¥¼ ë³€ê²½í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

```tsx
function Component() {
  const [filters, setFilters] = React.useState()
  const { data } = useQuery(['todos', filters], () => fetchTodos(filters))

  // âœ… set local state and let it "drive" the query
  return <Filters onApply={setFilters} />
}
```

*setFilters* ì—…ë°ì´íŠ¸ì— ì˜í•´ íŠ¸ë¦¬ê±°ëœ re-renderì—ì„œ ë‹¤ë¥¸ ì¿¼ë¦¬ í‚¤ë¥¼ React Queryì— ì „ë‹¬í•˜ì—¬ ë‹¤ì‹œ ê°€ì ¸ì˜µë‹ˆë‹¤. ì˜ˆì œëŠ” [#1: Practical React Query - Treat the query key like a dependency array](https://tkdodo.eu/blog/practical-react-query#treat-the-query-key-like-a-dependency-array)ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.

## **Manual Interaction**

ì¿¼ë¦¬ ìºì‹œì™€ì˜ ìˆ˜ë™ì  ìƒí˜¸ ì‘ìš©ì€ ì¿¼ë¦¬ í‚¤ì˜ êµ¬ì¡°ê°€ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì…ë‹ˆë‹¤. [invalidateQueries](https://react-query.tanstack.com/reference/QueryClient#queryclientinvalidatequeries) ë˜ëŠ” [setQueriesData](https://react-query.tanstack.com/reference/QueryClient#queryclientsetqueriesdata)ì™€ ê°™ì€ ë§ì€ ìƒí˜¸ ì‘ìš© ë©”ì„œë“œë¡œ ì¿¼ë¦¬ í‚¤ë¥¼ ì–•ê²Œ ì¼ì¹˜ì‹œí‚¬ ìˆ˜ ìˆëŠ” [Query Filters](https://react-query.tanstack.com/guides/filters#query-filters)ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.

## **Effective React Query Keys**

ì´ëŸ¬í•œ ì ë“¤ì€ (ì‚¬ì‹¤ ì´ ë¸”ë¡œê·¸ì˜ ëª¨ë“  ê²ƒê³¼ ë§ˆì°¬ê°€ì§€ë¡œ) ì œ ê°œì¸ì ì¸ ì˜ê²¬ì„ ë°˜ì˜í•˜ë¯€ë¡œ, ì¿¼ë¦¬ í‚¤ ì‘ì—…ì„ í•  ë•Œ ë°˜ë“œì‹œ í•´ì•¼ í•˜ëŠ” ê²Œ ì•„ë‹™ë‹ˆë‹¤. ì €ëŠ” ì´ëŸ¬í•œ ì „ëµë“¤ì´ ì•±ì˜ ë³µì¡ì„±ì´ ì¦ê°€í•  ë•Œ ê°€ì¥ ì˜ ë™ì‘í•˜ê³  ì˜ í™•ì¥ëœë‹¤ëŠ” ê²ƒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ê°„ë‹¨í•œ ì•±ì—ì„œëŠ” ì´ëŸ° ì‘ì—…ì„ ìˆ˜í–‰í•  í•„ìš”ê°€ ì—†ì–´ìš”ğŸ˜

## **Colocate**

ë§Œì•½ ë‹¹ì‹ ì´ ì•„ì§ [Kent C. Dodds](https://twitter.com/kentcdodds)ì˜ [Colocationì„ í†µí•œ Maintenability](https://kentcdodds.com/blog/colocation)ë¥¼ ì½ì§€ ì•Šì•˜ë‹¤ë©´ ê¼­ ë³´ì„¸ìš”. ëª¨ë“  ì¿¼ë¦¬ í‚¤ë¥¼ /src/utils/queryKeys.tsì— ê¸€ë¡œë²Œí•˜ê²Œ ì €ì¥í•œë‹¤ê³  ìƒí™©ì´ ê°œì„ ë˜ì§€ëŠ” ì•Šì„ ê²ƒì…ë‹ˆë‹¤. ê¸°ëŠ¥ ë””ë ‰í„°ë¦¬ì— ìˆëŠ” í•´ë‹¹ ì¿¼ë¦¬ ì˜†ì— ì¿¼ë¦¬ í‚¤ë¥¼ ë³´ê´€í•´ë³´ë©´ ì–´ë–¨ê¹Œìš”?

```tsx
- src
  - features
    - Profile
      - index.tsx
      - queries.ts
    - Todos
      - index.tsx
      - queries.ts
```

ì¿¼ë¦¬ íŒŒì¼ì—ëŠ” React Queryì™€ ê´€ë ¨ëœ ëª¨ë“  ë‚´ìš©ì´ í¬í•¨ë©ë‹ˆë‹¤. ì €ëŠ” ë³´í†µ Custom Hookë§Œ ë‚´ë³´ë‚´ë¯€ë¡œ ì‹¤ì œ ì¿¼ë¦¬ ê¸°ëŠ¥ë¿ë§Œ ì•„ë‹ˆë¼ ì¿¼ë¦¬ í‚¤ë„ ì§€ì—­ì ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.

## **Always use Array Keys**

ì¿¼ë¦¬ í‚¤ë„ ë¬¸ìì—´ì´ ë  ìˆ˜ ìˆì§€ë§Œ, í†µì¼ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ í•­ìƒ ë°°ì—´ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”. React QueryëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë¬¸ìì—´ì„ ë°°ì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

```tsx
// ğŸš¨ will be transformed to ['todos'] anyhow
useQuery('todos')
// âœ…
useQuery(['todos'])
```

React Query v4ì—ì„œëŠ” ëª¨ë“  í‚¤ê°€ ë°°ì—´ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.

## **Structure**

ì¿¼ë¦¬ í‚¤ë¥¼ ê°€ì¥ ì¼ë°˜ì ì¸ ê²ƒë¶€í„° ì„¸ë¶€ì ì¸ ê²ƒê¹Œì§€, í•´ë‹¹ ìˆ˜ì¤€ì„ êµ¬ì²´í™”í•˜ì—¬ êµ¬ì„±í•©ë‹ˆë‹¤. í•„í„°ë§ ê°€ëŠ¥í•œ ëª©ë¡ê³¼ ì„¸ë¶€ ë³´ê¸°ë¥¼ í—ˆìš©í•˜ëŠ” todos listë¥¼ êµ¬ì„±í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```tsx
['todos', 'list', { filters: 'all' }]
['todos', 'list', { filters: 'done' }]
['todos', 'detail', 1]
['todos', 'detail', 2]
```

ì´ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ë©´ ëª¨ë“  todos, list, detail ì •ë³´ë¥¼ ['todos']ì˜ ê´€ê³„ì—ì„œ ì œì™¸í•  ìˆ˜ ìˆì„ ë¿ë§Œ ì•„ë‹ˆë¼ ì •í™•í•œ í‚¤ë¥¼ ì•Œë©´ í•˜ë‚˜ì˜ íŠ¹ì • ëª©ë¡ì„ ëŒ€ìƒìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•„ìš”í•œ ê²½ìš° ëª¨ë“  ëª©ë¡ì„ ëŒ€ìƒìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ [Mutation Responseì˜ ì—…ë°ì´íŠ¸](https://react-query.tanstack.com/guides/updates-from-mutation-responses)ëŠ” í›¨ì”¬ ë” ìœ ì—°í•´ì§‘ë‹ˆë‹¤.

```tsx
function useUpdateTitle() {
  return useMutation(updateTitle, {
    onSuccess: (newTodo) => {
      // âœ… update the todo detail
      queryClient.setQueryData(['todos', 'detail', newTodo.id], newTodo)

      // âœ… update all the lists that contain this todo
      queryClient.setQueriesData(['todos', 'list'], (previous) =>
        previous.map((todo) => (todo.id === newTodo.id ? newtodo : todo))
      )
    },
  })
}
```

listì™€ detailì˜ êµ¬ì¡°ê°€ ë§ì´ ë‹¤ë¥´ë©´ ì´ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì´ë¥¼ ëŒ€ì‹ í•´ ëª¨ë“  listë¥¼ ë¬´íš¨í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx
function useUpdateTitle() {
  return useMutation(updateTitle, {
    onSuccess: (newTodo) => {
      queryClient.setQueryData(['todos', 'detail', newTodo.id], newTodo)

      // âœ… just invalidate all the lists
      queryClient.invalidateQueries(['todos', 'list'])
    },
  })
}
```

ì˜ˆë¥¼ ë“¤ì–´ urlì—ì„œ í•„í„°ë¥¼ ì½ì–´ í˜„ì¬ ì–´ë–¤ ëª©ë¡ì— ìˆëŠ”ì§€ ì•Œê³  ìˆìœ¼ë¯€ë¡œ ì •í™•í•œ ì¿¼ë¦¬ í‚¤ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤ë©´, ì´ ë‘ ê°€ì§€ ë°©ë²•ì„ ê²°í•©í•˜ì—¬ listì—ì„œ *setQueryData*ë¥¼ í˜¸ì¶œí•˜ê³  ë‹¤ë¥¸ ëª¨ë“  ê²ƒì„ ë¬´íš¨í™”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```tsx
function useUpdateTitle() {
  // imagine a custom hook that returns the current filters,
  // stored in the url
  const { filters } = useFilterParams()

  return useMutation(updateTitle, {
    onSuccess: (newTodo) => {
      queryClient.setQueryData(['todos', 'detail', newTodo.id], newTodo)

      // âœ… update the list we are currently on instantly
      queryClient.setQueryData(['todos', 'list', { filters }], (previous) =>
        previous.map((todo) => (todo.id === newTodo.id ? newtodo : todo))
      )

      // ğŸ¥³ invalidate all the lists, but don't refetch the active one
      queryClient.invalidateQueries({
        queryKey: ['todos', 'list'],
        refetchActive: false,
      })
    },
  })
}
```

v4ì—ì„œ *refetchActive*ê°€ *refetchType*ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ì˜ ì˜ˆì œì—ì„œ refetchType: 'noneâ€™ë¥¼ ì„ ì–¸í–ˆëŠ”ë°, ì•„ë¬´ê²ƒë„ ë‹¤ì‹œ ê²€ìƒ‰í•˜ì§€ ì•Šìœ¼ë ¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

## **Use Query Key factories**

ìœ„ì˜ ì˜ˆì œì—ì„œëŠ” ì§ì ‘ ì¿¼ë¦¬ í‚¤ë¥¼ ì„ ì–¸í–ˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê¸° ì‰¬ìš¸ ë¿ë§Œ ì•„ë‹ˆë¼ í‚¤ì— ë‹¤ë¥¸ ìˆ˜ì¤€ì˜ ì„¸ë¶„í™”ë¥¼ ì¶”ê°€í•˜ë ¤ëŠ” ê²½ìš°ì²˜ëŸ¼ í–¥í›„ ë³€ê²½ ì‘ì—…ì„ ë”ìš± ì–´ë µê²Œ ë§Œë“­ë‹ˆë‹¤.

ê·¸ê²ƒì´ ë‚´ê°€ í•¨ìˆ˜ë‹¹ í•˜ë‚˜ì˜ Query Key factoryë¥¼ ì¶”ì²œí•˜ëŠ” ì´ìœ ì…ë‹ˆë‹¤. ì˜¤ì§ entries and functionsì´ ìˆëŠ” ê°„ë‹¨í•œ ê°ì²´ì¼ ë¿ì´ë©° ì¿¼ë¦¬ í‚¤ë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ Custom Hookì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ì£ . ìœ„ì˜ ì˜ˆì œ êµ¬ì¡°ë¥¼ ë°”ê¾¼ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```tsx
const todoKeys = {
  all: ['todos'] as const,
  lists: () => [...todoKeys.all, 'list'] as const,
  list: (filters: string) => [...todoKeys.lists(), { filters }] as const,
  details: () => [...todoKeys.all, 'detail'] as const,
  detail: (id: number) => [...todoKeys.details(), id] as const,
}
```

ë”°ë¼ì„œ ê° ë ˆë²¨ì€ ë‹¤ë¥¸ ë ˆë²¨ ìœ„ì— êµ¬ì¶•ë˜ì§€ë§Œ ë…ë¦½ì ìœ¼ë¡œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìœ ì—°ì„±ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.

```tsx
// ğŸ•º remove everything related to the todos feature
queryClient.removeQueries(todoKeys.all)

// ğŸš€ invalidate all the lists
queryClient.invalidateQueries(todoKeys.lists())

// ğŸ™Œ prefetch a single todo
queryClient.prefetchQueries(todoKeys.detail(id), () => fetchTodo(id))
```